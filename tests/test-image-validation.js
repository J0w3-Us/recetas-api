// tests/test-image-validation.js
const supertest = require('supertest');
const express = require('express');
const { body } = require('express-validator');

/**
 * Test completo para validaci√≥n de imageUrl en recetas
 * Verifica que el campo imageUrl funciona correctamente en POST y PUT
 */

// Mock del controlador para pruebas
const mockController = {
    create: (req, res) => {
        const errors = require('express-validator').validationResult(req);
        if (!errors.isEmpty()) {
            return res.status(400).json({ errors: errors.array() });
        }
        res.status(201).json({
            id: 123,
            name: req.body.name,
            description: req.body.description,
            steps: req.body.steps,
            ingredients: req.body.ingredients,
            imageUrl: req.body.imageUrl,
            userId: 'test-user-123',
            createdAt: new Date().toISOString()
        });
    },

    updateById: (req, res) => {
        const errors = require('express-validator').validationResult(req);
        if (!errors.isEmpty()) {
            return res.status(400).json({ errors: errors.array() });
        }
        res.status(200).json({
            id: parseInt(req.params.id),
            name: req.body.name || 'Receta existente',
            description: req.body.description || 'Descripci√≥n existente',
            steps: req.body.steps || ['Paso 1'],
            ingredients: req.body.ingredients || ['Ingrediente 1'],
            imageUrl: req.body.imageUrl,
            userId: 'test-user-123',
            createdAt: '2025-10-29T10:00:00.000Z'
        });
    }
};

// Mock del middleware de autenticaci√≥n
const mockAuth = (req, res, next) => {
    req.user = { id: 'test-user-123' };
    next();
};

// Configurar app de prueba
const app = express();
app.use(express.json());

// Rutas con validaci√≥n de imageUrl
app.post('/api/recetas',
    mockAuth,
    [
        body('name').trim().notEmpty().isLength({ min: 3 }),
        body('description').trim().notEmpty(),
        body('steps').isArray({ min: 1 }),
        body('ingredients').isArray({ min: 1 }),
        body('imageUrl')
            .optional()
            .trim()
            .isURL({ protocols: ['http', 'https'], require_protocol: true })
            .withMessage('La URL de la imagen debe ser v√°lida (http/https).')
            .isLength({ max: 2000 })
            .withMessage('La URL de la imagen no puede exceder 2000 caracteres.')
    ],
    mockController.create
);

app.put('/api/recetas/:id',
    mockAuth,
    [
        require('express-validator').param('id').isNumeric(),
        body('name').optional().trim().isLength({ min: 3 }),
        body('description').optional().trim().notEmpty(),
        body('steps').optional().isArray({ min: 1 }),
        body('ingredients').optional().isArray({ min: 1 }),
        body('imageUrl')
            .optional()
            .trim()
            .isURL({ protocols: ['http', 'https'], require_protocol: true })
            .withMessage('La URL de la imagen debe ser v√°lida (http/https).')
            .isLength({ max: 2000 })
            .withMessage('La URL de la imagen no puede exceder 2000 caracteres.')
    ],
    mockController.updateById
);

const request = supertest(app);

// Tests para el campo imageUrl
async function runImageValidationTests() {
    console.log('üñºÔ∏è  INICIANDO TESTS DE VALIDACI√ìN DE IM√ÅGENES\n');

    const tests = [
        {
            name: '‚úÖ POST con imageUrl v√°lida (HTTPS)',
            test: async () => {
                const payload = {
                    name: 'Receta con imagen',
                    description: 'Descripci√≥n con imagen',
                    steps: ['Paso 1'],
                    ingredients: ['Ingrediente 1'],
                    imageUrl: 'https://ejemplo.com/imagen.jpg'
                };

                const response = await request
                    .post('/api/recetas')
                    .send(payload)
                    .expect(201);

                if (response.body.imageUrl !== payload.imageUrl) {
                    throw new Error(`ImageUrl esperada: ${payload.imageUrl}, recibida: ${response.body.imageUrl}`);
                }
            }
        },

        {
            name: '‚úÖ POST con imageUrl v√°lida (HTTP)',
            test: async () => {
                const payload = {
                    name: 'Receta con imagen HTTP',
                    description: 'Descripci√≥n con imagen HTTP',
                    steps: ['Paso 1'],
                    ingredients: ['Ingrediente 1'],
                    imageUrl: 'http://ejemplo.com/imagen.png'
                };

                const response = await request
                    .post('/api/recetas')
                    .send(payload)
                    .expect(201);

                if (response.body.imageUrl !== payload.imageUrl) {
                    throw new Error(`ImageUrl esperada: ${payload.imageUrl}, recibida: ${response.body.imageUrl}`);
                }
            }
        },

        {
            name: '‚úÖ POST sin imageUrl (campo opcional)',
            test: async () => {
                const payload = {
                    name: 'Receta sin imagen',
                    description: 'Descripci√≥n sin imagen',
                    steps: ['Paso 1'],
                    ingredients: ['Ingrediente 1']
                    // No se incluye imageUrl
                };

                const response = await request
                    .post('/api/recetas')
                    .send(payload)
                    .expect(201);

                // imageUrl deber√≠a ser undefined o null
                if (response.body.imageUrl !== undefined && response.body.imageUrl !== null) {
                    throw new Error(`ImageUrl deber√≠a ser undefined/null, recibida: ${response.body.imageUrl}`);
                }
            }
        },

        {
            name: '‚ùå POST con imageUrl inv√°lida (sin protocolo)',
            test: async () => {
                const payload = {
                    name: 'Receta con URL inv√°lida',
                    description: 'Descripci√≥n',
                    steps: ['Paso 1'],
                    ingredients: ['Ingrediente 1'],
                    imageUrl: 'www.ejemplo.com/imagen.jpg'
                };

                const response = await request
                    .post('/api/recetas')
                    .send(payload)
                    .expect(400);

                const errorFound = response.body.errors.some(error =>
                    error.param === 'imageUrl' &&
                    error.msg.includes('v√°lida')
                );

                if (!errorFound) {
                    throw new Error('Deber√≠a haber un error de validaci√≥n para imageUrl');
                }
            }
        },

        {
            name: '‚ùå POST con imageUrl muy larga (>2000 caracteres)',
            test: async () => {
                const longUrl = 'https://ejemplo.com/' + 'a'.repeat(2000);
                const payload = {
                    name: 'Receta con URL muy larga',
                    description: 'Descripci√≥n',
                    steps: ['Paso 1'],
                    ingredients: ['Ingrediente 1'],
                    imageUrl: longUrl
                };

                const response = await request
                    .post('/api/recetas')
                    .send(payload)
                    .expect(400);

                const errorFound = response.body.errors.some(error =>
                    error.param === 'imageUrl' &&
                    error.msg.includes('2000 caracteres')
                );

                if (!errorFound) {
                    throw new Error('Deber√≠a haber un error de longitud para imageUrl');
                }
            }
        },

        {
            name: '‚úÖ PUT actualizar solo imageUrl',
            test: async () => {
                const payload = {
                    imageUrl: 'https://nuevaimagen.com/foto.jpg'
                };

                const response = await request
                    .put('/api/recetas/123')
                    .send(payload)
                    .expect(200);

                if (response.body.imageUrl !== payload.imageUrl) {
                    throw new Error(`ImageUrl esperada: ${payload.imageUrl}, recibida: ${response.body.imageUrl}`);
                }
            }
        },

        {
            name: '‚úÖ PUT remover imageUrl (null)',
            test: async () => {
                const payload = {
                    imageUrl: null
                };

                const response = await request
                    .put('/api/recetas/123')
                    .send(payload)
                    .expect(200);

                if (response.body.imageUrl !== null) {
                    throw new Error(`ImageUrl deber√≠a ser null, recibida: ${response.body.imageUrl}`);
                }
            }
        },

        {
            name: '‚ùå PUT con imageUrl inv√°lida (protocolo FTP)',
            test: async () => {
                const payload = {
                    imageUrl: 'ftp://servidor.com/imagen.jpg'
                };

                const response = await request
                    .put('/api/recetas/123')
                    .send(payload)
                    .expect(400);

                const errorFound = response.body.errors.some(error =>
                    error.param === 'imageUrl' &&
                    error.msg.includes('v√°lida')
                );

                if (!errorFound) {
                    throw new Error('Deber√≠a haber un error de protocolo para imageUrl');
                }
            }
        }
    ];

    // Ejecutar todos los tests
    let passed = 0;
    let failed = 0;

    for (const testCase of tests) {
        try {
            await testCase.test();
            console.log(`${testCase.name} - PAS√ì`);
            passed++;
        } catch (error) {
            console.log(`${testCase.name} - FALL√ì: ${error.message}`);
            failed++;
        }
    }

    console.log(`\nüìä RESUMEN DE TESTS DE IM√ÅGENES:`);
    console.log(`‚úÖ Pasaron: ${passed}`);
    console.log(`‚ùå Fallaron: ${failed}`);
    console.log(`üìà Total: ${passed + failed}`);

    if (failed === 0) {
        console.log('\nüéâ ¬°Todos los tests de validaci√≥n de im√°genes pasaron!');
    } else {
        console.log('\n‚ö†Ô∏è  Algunos tests fallaron. Revisar implementaci√≥n.');
    }
}

// Ejecutar si es llamado directamente
if (require.main === module) {
    runImageValidationTests().catch(console.error);
}

module.exports = { runImageValidationTests };